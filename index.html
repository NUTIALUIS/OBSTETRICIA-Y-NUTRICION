<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBSTNUT - Sistema de Historia Cl√≠nica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { padding: 20px; background: #f9f0ff; }
        .form-container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .hidden { display: none; }
        .logout-btn { position: absolute; top: 20px; right: 20px; }
        .card-paciente { margin-bottom: 15px; border-left: 4px solid #9C27B0; }
        .btn-guardar { background: #9C27B0; color: white; }
        .btn-danger { background: #e91e63; color: white; }
        .brand-title { color: #9C27B0; font-weight: bold; }
        .console-log { background: #2c2c2c; color: #00ff00; padding: 10px; border-radius: 5px; font-family: monospace; margin-top: 10px; }
    </style>
</head>
<body>

<!-- Login / Registro -->
<div id="auth-section" class="form-container">
    <h3 class="text-center mb-4 brand-title">üîê Acceso Profesional - OBSTNUT</h3>
    <input type="email" id="email" class="form-control mb-3" placeholder="Tu email profesional" required>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required>
    <button onclick="login()" class="btn btn-primary w-100 mb-2">Ingresar</button>
    <button onclick="register()" class="btn btn-outline-secondary w-100">Crear Cuenta (solo t√∫)</button>
    <div id="auth-message" class="mt-3 text-center text-danger"></div>
</div>

<!-- Panel Principal -->
<div id="main-app" class="hidden">
    <button onclick="logout()" class="btn btn-outline-danger logout-btn">Cerrar Sesi√≥n</button>

    <!-- Registrar Paciente -->
    <div class="form-container">
        <h4 class="brand-title">‚ûï Registrar Nuevo Paciente - OBSTNUT</h4>
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="nombrePaciente" class="form-control mb-2" placeholder="Nombre completo" required>
            </div>
            <div class="col-md-6">
                <input type="tel" id="telefonoPaciente" class="form-control mb-2" placeholder="Tel√©fono / WhatsApp" required>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <select id="tipoConsulta" class="form-control mb-2">
                    <option value="">Especialidad</option>
                    <option value="Nutrici√≥n">Nutrici√≥n</option>
                    <option value="Obstetricia">Obstetricia</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="date" id="fechaNacimiento" class="form-control mb-2" placeholder="Fecha de nacimiento">
            </div>
        </div>
        <button onclick="registrarPaciente()" class="btn btn-guardar w-100">‚úÖ Registrar Paciente</button>
    </div>

    <!-- Atender Paciente -->
    <div class="form-container">
        <h4 class="brand-title">üìã Atender Paciente - OBSTNUT</h4>
        <select id="listaPacientesAtencion" class="form-control mb-3">
            <option value="">Selecciona un paciente</option>
        </select>

        <h5>Signos Vitales</h5>
        <div class="row">
            <div class="col-md-3">
                <input type="number" id="peso" class="form-control mb-2" placeholder="Peso (kg)">
            </div>
            <div class="col-md-3">
                <input type="number" id="talla" class="form-control mb-2" placeholder="Talla (cm)">
            </div>
            <div class="col-md-3">
                <input type="text" id="pa" class="form-control mb-2" placeholder="PA (ej: 120/80)">
            </div>
            <div class="col-md-3">
                <input type="number" id="fc" class="form-control mb-2" placeholder="FC (lpm)">
            </div>
        </div>

        <h5>Historia Cl√≠nica</h5>
        <textarea id="motivoConsulta" class="form-control mb-2" placeholder="Motivo de consulta" rows="2"></textarea>
        <textarea id="antecedentes" class="form-control mb-2" placeholder="Antecedentes personales/familiares" rows="2"></textarea>
        <textarea id="diagnostico" class="form-control mb-2" placeholder="Diagn√≥stico" rows="2"></textarea>
        <textarea id="tratamiento" class="form-control mb-2" placeholder="Tratamiento / Recomendaciones" rows="3"></textarea>

        <button onclick="guardarHistoriaClinica()" class="btn btn-guardar w-100 mt-3">üíæ Guardar Historia Cl√≠nica</button>
    </div>

    <!-- Lista de Pacientes -->
    <div class="form-container">
        <h4 class="brand-title">üìä Pacientes Registrados - OBSTNUT</h4>
        <div id="listaPacientes" class="list-group">
            <div class="text-center">Cargando pacientes...</div>
        </div>
    </div>
</div>

<script>
    // ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è
    // Ve a Firebase Console > Project Settings > T√∫ app web > Copia el objeto firebaseConfig
    const firebaseConfig = {
        apiKey: "PEGAAQUI-TU-API-KEY",
        authDomain: "obstnut-app.firebaseapp.com",
        projectId: "obstnut-app",
        storageBucket: "obstnut-app.appspot.com",
        messagingSenderId: "PEGAAQUI-TU-ID",
        appId: "PEGAAQUI-TU-APP-ID"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function showAuth() {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    function showApp() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        cargarPacientes();
    }

    function register() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password || password.length < 6) {
            showMessage("‚ö†Ô∏è Email y contrase√±a (m√≠n. 6 caracteres) son obligatorios.");
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                showMessage("‚úÖ ¬°Cuenta creada! Bienvenida a OBSTNUT.");
                showApp();
            })
            .catch(error => {
                console.error("Error registro:", error);
                showMessage("‚ùå Error: " + error.message);
            });
    }

    function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
            showMessage("‚ö†Ô∏è Email y contrase√±a son obligatorios.");
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                showMessage("‚úÖ ¬°Bienvenida a OBSTNUT!");
                showApp();
            })
            .catch(error => {
                console.error("Error login:", error);
                showMessage("‚ùå Error: " + error.message);
            });
    }

    function logout() {
        auth.signOut();
        showAuth();
    }

    function registrarPaciente() {
        const paciente = {
            nombre: document.getElementById('nombrePaciente').value.trim(),
            telefono: document.getElementById('telefonoPaciente').value.trim(),
            tipoConsulta: document.getElementById('tipoConsulta').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            userId: auth.currentUser.uid,
            fechaRegistro: new Date()
        };

        if (!paciente.nombre || !paciente.telefono) {
            showMessage("‚ö†Ô∏è Nombre y tel√©fono son obligatorios.");
            return;
        }

        db.collection("pacientes").add(paciente)
            .then(() => {
                showMessage("‚úÖ Paciente registrado en OBSTNUT.");
                cargarPacientes();
                limpiarFormularioPaciente();
            })
            .catch(error => {
                console.error("Error guardando paciente:", error);
                showMessage("‚ùå Error al registrar paciente.");
            });
    }

    function cargarPacientes() {
        const listaSelect = document.getElementById('listaPacientesAtencion');
        const listaDiv = document.getElementById('listaPacientes');

        listaSelect.innerHTML = '<option value="">Selecciona un paciente</option>';
        listaDiv.innerHTML = '<div class="text-center">Cargando...</div>';

        db.collection("pacientes").where("userId", "==", auth.currentUser.uid)
            .orderBy("fechaRegistro", "desc")
            .onSnapshot(snapshot => {
                listaSelect.innerHTML = '<option value="">Selecciona un paciente</option>';
                listaDiv.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;

                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.nombre;
                    listaSelect.appendChild(option);

                    const card = document.createElement('div');
                    card.className = 'card card-paciente p-3';
                    card.innerHTML = `
                        <h5>${data.nombre} <small class="text-muted">(${data.tipoConsulta})</small></h5>
                        <p>üì± ${data.telefono} | üéÇ ${data.fechaNacimiento || 'No especificada'}</p>
                        <button onclick="verHistorial('${id}')" class="btn btn-sm btn-outline-primary">Ver Historial</button>
                        <hr>
                    `;
                    listaDiv.appendChild(card);
                });
            });
    }

    function guardarHistoriaClinica() {
        const pacienteId = document.getElementById('listaPacientesAtencion').value;
        if (!pacienteId) {
            showMessage("‚ö†Ô∏è Selecciona un paciente primero.");
            return;
        }

        const historia = {
            pacienteId: pacienteId,
            peso: document.getElementById('peso').value,
            talla: document.getElementById('talla').value,
            pa: document.getElementById('pa').value,
            fc: document.getElementById('fc').value,
            motivoConsulta: document.getElementById('motivoConsulta').value,
            antecedentes: document.getElementById('antecedentes').value,
            diagnostico: document.getElementById('diagnostico').value,
            tratamiento: document.getElementById('tratamiento').value,
            userId: auth.currentUser.uid,
            fechaAtencion: new Date()
        };

        db.collection("historias_clinicas").add(historia)
            .then(() => {
                showMessage("‚úÖ Historia cl√≠nica guardada en OBSTNUT.");
                limpiarFormularioHistoria();
            })
            .catch(error => {
                console.error("Error guardando historia:", error);
                showMessage("‚ùå Error al guardar historia cl√≠nica.");
            });
    }

    function verHistorial(pacienteId) {
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìã Historial Cl√≠nico - OBSTNUT</h5>
                        <button type="button" class="btn-close" onclick="cerrarModal()"></button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <p>Cargando historial...</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        db.collection("pacientes").doc(pacienteId).get().then(pacienteDoc => {
            const paciente = pacienteDoc.data();
            let html = `<h5>üë©‚Äç‚öïÔ∏è ${paciente.nombre} - ${paciente.tipoConsulta}</h5>`;
            html += `<p>üì± ${paciente.telefono} | üéÇ ${paciente.fechaNacimiento || 'No especificada'}</p><hr>`;

            db.collection("historias_clinicas").where("pacienteId", "==", pacienteId)
                .orderBy("fechaAtencion", "desc")
                .get().then(snapshot => {
                    if (snapshot.empty) {
                        html += "<p class='text-muted'>üì≠ No hay historial cl√≠nico a√∫n.</p>";
                    } else {
                        snapshot.forEach(doc => {
                            const hc = doc.data();
                            const fecha = hc.fechaAtencion.toDate().toLocaleString();
                            html += `
                                <div class="mb-4 p-3 border rounded bg-light">
                                    <small class="text-muted">üìÖ Atendido el: ${fecha}</small>
                                    <p><strong>‚öñÔ∏è Peso:</strong> ${hc.peso || '-'} kg | <strong>üìè Talla:</strong> ${hc.talla || '-'} cm</p>
                                    <p><strong>üíì PA:</strong> ${hc.pa || '-'} | <strong>‚ù§Ô∏è FC:</strong> ${hc.fc || '-'}</p>
                                    <p><strong>üìù Motivo:</strong> ${hc.motivoConsulta || '-'}</p>
                                    <p><strong>üß¨ Antecedentes:</strong> ${hc.antecedentes || '-'}</p>
                                    <p><strong>ü©∫ Diagn√≥stico:</strong> ${hc.diagnostico || '-'}</p>
                                    <p><strong>üíä Tratamiento:</strong> ${hc.tratamiento || '-'}</p>
                                </div>
                            `;
                        });
                    }
                    document.getElementById('modal-body').innerHTML = html;
                });
    }

    function cerrarModal() {
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
    }

    function limpiarFormularioPaciente() {
        document.getElementById('nombrePaciente').value = '';
        document.getElementById('telefonoPaciente').value = '';
        document.getElementById('tipoConsulta').value = '';
        document.getElementById('fechaNacimiento').value = '';
    }

    function limpiarFormularioHistoria() {
        document.getElementById('peso').value = '';
        document.getElementById('talla').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('motivoConsulta').value = '';
        document.getElementById('antecedentes').value = '';
        document.getElementById('diagnostico').value = '';
        document.getElementById('tratamiento').value = '';
    }

    function showMessage(msg) {
        const div = document.getElementById('auth-message');
        div.innerText = msg;
        setTimeout(() => div.innerText = '', 6000);
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            showApp();
        } else {
            showAuth();
        }
    });

    showAuth();
</script>

</body>
</html>
