<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ObsNut - Historia Cl√≠nica Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .form-container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .hidden { display: none; }
        .logout-btn { position: absolute; top: 20px; right: 20px; }
        .card-paciente { margin-bottom: 15px; border-left: 4px solid #4CAF50; }
        .btn-guardar { background: #4CAF50; color: white; }
        .btn-danger { background: #e91e63; color: white; }
    </style>
</head>
<body>

<!-- Login / Registro -->
<div id="auth-section" class="form-container">
    <h3 class="text-center mb-4">üîê Acceso Profesional - ObsNut</h3>
    <input type="email" id="email" class="form-control mb-3" placeholder="Tu email profesional" required>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a" required>
    <button onclick="login()" class="btn btn-primary w-100 mb-2">Ingresar</button>
    <button onclick="register()" class="btn btn-outline-secondary w-100">Crear Cuenta (solo t√∫)</button>
    <div id="auth-message" class="mt-3 text-center text-danger"></div>
</div>

<!-- Panel Principal -->
<div id="main-app" class="hidden">
    <button onclick="logout()" class="btn btn-outline-danger logout-btn">Cerrar Sesi√≥n</button>

    <!-- Registrar Paciente -->
    <div class="form-container">
        <h4>‚ûï Registrar Nuevo Paciente</h4>
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="nombrePaciente" class="form-control mb-2" placeholder="Nombre completo" required>
            </div>
            <div class="col-md-6">
                <input type="tel" id="telefonoPaciente" class="form-control mb-2" placeholder="Tel√©fono / WhatsApp" required>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <select id="tipoConsulta" class="form-control mb-2">
                    <option value="">Especialidad</option>
                    <option value="Nutrici√≥n">Nutrici√≥n</option>
                    <option value="Obstetricia">Obstetricia</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="date" id="fechaNacimiento" class="form-control mb-2" placeholder="Fecha de nacimiento">
            </div>
        </div>
        <button onclick="registrarPaciente()" class="btn btn-guardar w-100">‚úÖ Registrar Paciente</button>
    </div>

    <!-- Atender Paciente (Signos Vitales + Historia Cl√≠nica) -->
    <div class="form-container">
        <h4>üìã Atender Paciente - Historia Cl√≠nica</h4>
        <select id="listaPacientesAtencion" class="form-control mb-3">
            <option value="">Selecciona un paciente</option>
            <!-- Se llenar√° autom√°ticamente -->
        </select>

        <h5>Signos Vitales</h5>
        <div class="row">
            <div class="col-md-3">
                <input type="number" id="peso" class="form-control mb-2" placeholder="Peso (kg)">
            </div>
            <div class="col-md-3">
                <input type="number" id="talla" class="form-control mb-2" placeholder="Talla (cm)">
            </div>
            <div class="col-md-3">
                <input type="text" id="pa" class="form-control mb-2" placeholder="PA (ej: 120/80)">
            </div>
            <div class="col-md-3">
                <input type="number" id="fc" class="form-control mb-2" placeholder="FC (lpm)">
            </div>
        </div>

        <h5>Historia Cl√≠nica</h5>
        <textarea id="motivoConsulta" class="form-control mb-2" placeholder="Motivo de consulta" rows="2"></textarea>
        <textarea id="antecedentes" class="form-control mb-2" placeholder="Antecedentes personales/familiares" rows="2"></textarea>
        <textarea id="diagnostico" class="form-control mb-2" placeholder="Diagn√≥stico" rows="2"></textarea>
        <textarea id="tratamiento" class="form-control mb-2" placeholder="Tratamiento / Recomendaciones" rows="3"></textarea>

        <button onclick="guardarHistoriaClinica()" class="btn btn-guardar w-100 mt-3">üíæ Guardar Historia Cl√≠nica</button>
    </div>

    <!-- Lista de Pacientes con Historial -->
    <div class="form-container">
        <h4>üìä Pacientes Registrados</h4>
        <div id="listaPacientes" class="list-group">
            <!-- Aqu√≠ se cargan los pacientes -->
        </div>
    </div>
</div>

<script>
    // üëáüëáüëá REEMPLAZA ESTO POR TU CONFIGURACI√ìN DE FIREBASE üëáüëáüëá
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "obsnut-app.firebaseapp.com",
        projectId: "obsnut-app",
        storageBucket: "obsnut-app.appspot.com",
        messagingSenderId: "TU_ID",
        appId: "TU_APP_ID"
    };
    // üëÜüëÜüëÜ REEMPLAZA ESTO POR TU CONFIGURACI√ìN DE FIREBASE üëÜüëÜüëÜ

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Mostrar/Ocultar secciones
    function showAuth() {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    function showApp() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        cargarPacientes();
    }

    // Registro (solo para ti, el profesional)
    function register() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                showMessage("‚úÖ Cuenta creada. Bienvenida a ObsNut.");
                showApp();
            })
            .catch(error => showMessage("Error: " + error.message));
    }

    // Login
    function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                showMessage("‚úÖ Bienvenida a ObsNut, Dra. Nalu√≠s.");
                showApp();
            })
            .catch(error => showMessage("Error: " + error.message));
    }

    // Logout
    function logout() {
        auth.signOut();
        showAuth();
    }

    // Registrar Paciente
    function registrarPaciente() {
        const paciente = {
            nombre: document.getElementById('nombrePaciente').value.trim(),
            telefono: document.getElementById('telefonoPaciente').value.trim(),
            tipoConsulta: document.getElementById('tipoConsulta').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            userId: auth.currentUser.uid,
            fechaRegistro: new Date()
        };

        if (!paciente.nombre || !paciente.telefono) {
            showMessage("‚ö†Ô∏è Nombre y tel√©fono son obligatorios.");
            return;
        }

        db.collection("pacientes").add(paciente)
            .then(doc => {
                showMessage("‚úÖ Paciente registrado.");
                cargarPacientes();
                limpiarFormularioPaciente();
            })
            .catch(error => showMessage("Error: " + error.message));
    }

    // Cargar Pacientes en la lista de atenci√≥n y en el historial
    function cargarPacientes() {
        const listaSelect = document.getElementById('listaPacientesAtencion');
        const listaDiv = document.getElementById('listaPacientes');
        listaSelect.innerHTML = '<option value="">Selecciona un paciente</option>';
        listaDiv.innerHTML = '<div class="text-center">Cargando pacientes...</div>';

        db.collection("pacientes").where("userId", "==", auth.currentUser.uid)
            .orderBy("fechaRegistro", "desc")
            .onSnapshot(snapshot => {
                listaSelect.innerHTML = '<option value="">Selecciona un paciente</option>';
                listaDiv.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;

                    // Opci√≥n para el select de atenci√≥n
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.nombre;
                    listaSelect.appendChild(option);

                    // Tarjeta en historial
                    const card = document.createElement('div');
                    card.className = 'card card-paciente p-3';
                    card.innerHTML = `
                        <h5>${data.nombre} <small class="text-muted">(${data.tipoConsulta})</small></h5>
                        <p>üì± ${data.telefono} | üéÇ ${data.fechaNacimiento || 'No especificada'}</p>
                        <button onclick="verHistorial('${id}')" class="btn btn-sm btn-outline-primary">Ver Historial Cl√≠nico</button>
                        <hr>
                    `;
                    listaDiv.appendChild(card);
                });
            });
    }

    // Guardar Historia Cl√≠nica
    function guardarHistoriaClinica() {
        const pacienteId = document.getElementById('listaPacientesAtencion').value;
        if (!pacienteId) {
            showMessage("‚ö†Ô∏è Selecciona un paciente primero.");
            return;
        }

        const historia = {
            pacienteId: pacienteId,
            peso: document.getElementById('peso').value,
            talla: document.getElementById('talla').value,
            pa: document.getElementById('pa').value,
            fc: document.getElementById('fc').value,
            motivoConsulta: document.getElementById('motivoConsulta').value,
            antecedentes: document.getElementById('antecedentes').value,
            diagnostico: document.getElementById('diagnostico').value,
            tratamiento: document.getElementById('tratamiento').value,
            userId: auth.currentUser.uid,
            fechaAtencion: new Date()
        };

        db.collection("historias_clinicas").add(historia)
            .then(() => {
                showMessage("‚úÖ Historia cl√≠nica guardada.");
                limpiarFormularioHistoria();
            })
            .catch(error => showMessage("Error: " + error.message));
    }

    // Ver Historial Cl√≠nico de un paciente
    function verHistorial(pacienteId) {
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Historial Cl√≠nico</h5>
                        <button type="button" class="btn-close" onclick="cerrarModal()"></button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <p>Cargando...</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Cargar datos del paciente
        db.collection("pacientes").doc(pacienteId).get().then(pacienteDoc => {
            const paciente = pacienteDoc.data();
            let html = `<h5>${paciente.nombre} - ${paciente.tipoConsulta}</h5>`;
            html += `<p>üì± ${paciente.telefono} | üéÇ ${paciente.fechaNacimiento || 'No especificada'}</p><hr>`;

            // Cargar historias cl√≠nicas
            db.collection("historias_clinicas").where("pacienteId", "==", pacienteId)
                .orderBy("fechaAtencion", "desc")
                .get().then(snapshot => {
                    if (snapshot.empty) {
                        html += "<p class='text-muted'>No hay historial cl√≠nico a√∫n.</p>";
                    } else {
                        snapshot.forEach(doc => {
                            const hc = doc.data();
                            html += `
                                <div class="mb-4 p-3 border rounded">
                                    <small class="text-muted">Atendido el: ${hc.fechaAtencion.toDate().toLocaleString()}</small>
                                    <p><strong>Peso:</strong> ${hc.peso || '-'} kg | <strong>Talla:</strong> ${hc.talla || '-'} cm</p>
                                    <p><strong>PA:</strong> ${hc.pa || '-'} | <strong>FC:</strong> ${hc.fc || '-'}</p>
                                    <p><strong>Motivo:</strong> ${hc.motivoConsulta || '-'}</p>
                                    <p><strong>Antecedentes:</strong> ${hc.antecedentes || '-'}</p>
                                    <p><strong>Diagn√≥stico:</strong> ${hc.diagnostico || '-'}</p>
                                    <p><strong>Tratamiento:</strong> ${hc.tratamiento || '-'}</p>
                                </div>
                            `;
                        });
                    }
                    document.getElementById('modal-body').innerHTML = html;
                });
    }

    function cerrarModal() {
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
    }

    function limpiarFormularioPaciente() {
        document.getElementById('nombrePaciente').value = '';
        document.getElementById('telefonoPaciente').value = '';
        document.getElementById('tipoConsulta').value = '';
        document.getElementById('fechaNacimiento').value = '';
    }

    function limpiarFormularioHistoria() {
        document.getElementById('peso').value = '';
        document.getElementById('talla').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('motivoConsulta').value = '';
        document.getElementById('antecedentes').value = '';
        document.getElementById('diagnostico').value = '';
        document.getElementById('tratamiento').value = '';
    }

    function showMessage(msg) {
        const div = document.getElementById('auth-message');
        div.innerText = msg;
        setTimeout(() => div.innerText = '', 5000);
    }

    // Verificar estado de autenticaci√≥n
    auth.onAuthStateChanged(user => {
        if (user) {
            showApp();
        } else {
            showAuth();
        }
    });
</script>

</body>
</html>
